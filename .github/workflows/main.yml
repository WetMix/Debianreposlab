name: CI/CD Pipeline


on:

  push:

    branches: [main]

  pull_request:

    branches: [main]

jobs:


  build-and-test:

    runs-on: ubuntu-latest

    steps:

      - name: Checkout code

        uses: actions/checkout@v3

      - name: Set up Python 3.9

        uses: actions/setup-python@v3

        with:

          python-version: '3.9'

      - name: Install dependencies and test

        run: |

          python -m pip install --upgrade pip

          pip install flake8 pytest

          flake8 .

          pytest

  docker-build-push:

    needs: build-and-test

    runs-on: ubuntu-latest

    steps:

      - name: Checkout code

        uses: actions/checkout@v3

      - name: Set up Docker Buildx

        uses: docker/setup-buildx-action@v2

      - name: Log in to Docker Hub

        uses: docker/login-action@v2

        with:

          username: ${{ secrets.DOCKERHUB_USERNAME }}

          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image

        uses: docker/build-push-action@v4

        with:

          context: ./Debianreposlab/my-app

          push: true

         tags: ${{ secrets.DOCKERHUB_USERNAME }}/my-app:latest

  deploy-to-vm:

    needs: docker-build-push

    runs-on: ubuntu-latest

    steps:

      - name: Checkout code

        uses: actions/checkout@v3

      - name: Set up SSH Agent

        uses: webfactory/ssh-agent@v0.7.0

        with:

          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add host key to known_hosts

        run: ssh-keyscan 192.168.37.129 >> ~/.ssh/known_hosts

      - name: Deploy to server

        env:

          SSH_HOST: 192.168.37.129

          SSH_USER: devops_user

        run: |

          ssh ${{ env.SSH_HOST }} "
            cd ~/Debianreposlab/my_app &&
            docker stop my-app-image || true &&
            docker rm my-app-container || true &&
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/my-app:latest &&
            docker run -d -p 8081:80 --name my-app-image ${{ secrets.DOCKERHUB_USERNAME }}/my-app:latest
          "
